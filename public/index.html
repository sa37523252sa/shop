<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>簡易商品訂購系統（local）</title>
<style>
  body{font-family: Arial, "Noto Sans TC", sans-serif; margin:16px; background:#f7f7f8;}
  header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#fff;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
  h1{margin:0;font-size:18px}
  .btn{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
  .btn-primary{background:#2b8cff;color:#fff;border-color:#2b8cff}
  .container{margin-top:12px}
  .card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,0.04);margin-bottom:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .product-img{width:100%;height:150px;object-fit:cover;border-radius:6px;background:#eee}
  form .row{display:flex;gap:8px;margin-bottom:8px}
  label{font-size:13px}
  input, select, textarea{padding:6px;border-radius:6px;border:1px solid #ccc;width:100%}
  table{width:100%;border-collapse:collapse}
  th,td{padding:6px;border:1px solid #eee;text-align:left}
  .small{font-size:13px;color:#666}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .right{margin-left:auto}
  .orders-list{max-height:300px;overflow:auto}
  .muted{color:#666;font-size:13px}
  .admin-badge{background:#ffd700;padding:4px 8px;border-radius:999px;font-size:12px}
  .search-row{display:flex;gap:8px;margin-bottom:8px}
</style>
</head>
<body>
<header>
  <h1>簡易商品訂購系統（local demo）</h1>
  <div id="userArea">
    <!-- 動態填入登入/使用者按鈕 -->
  </div>
</header>

<div class="container">
  <div class="card">
    <div style="display:flex;align-items:center;gap:12px;">
      <div style="flex:1">
        <div class="search-row">
          <input id="searchInput" placeholder="輸入關鍵字（單字也可）搜尋商品/選項" />
          <button class="btn" id="searchBtn">搜尋</button>
          <button class="btn" id="clearSearch">清除</button>
        </div>
        <div class="small">已登入：<span id="currentUserInfo">未登入</span></div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary" id="openRegister">註冊 / 登入</button>
        <button class="btn" id="openAdminPanel">管理後台</button>
      </div>
    </div>
  </div>

  <div id="mainContent" class="grid">
    <!-- 商品卡片會動態生成 -->
  </div>

  <!-- 管理員新增商品表單（modal-like） -->
  <div id="adminPanel" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);min-width:320px;max-width:900px;z-index:50">
    <div class="card">
      <div style="display:flex;align-items:center;gap:8px">
        <h3 style="margin:0">管理後台</h3>
        <div class="right actions">
          <button class="btn" id="closeAdmin">關閉</button>
        </div>
      </div>

      <div id="adminContent" style="margin-top:12px">
        <!-- 管理員欄位 -->
        <div id="adminControls">
          <button class="btn" id="showAddProduct">新增商品</button>
          <button class="btn" id="showOrders">查看訂單紀錄</button>
          <div class="muted" style="margin-top:8px">註：管理員碼可在註冊時輸入（預設示範碼 <code>letmein123</code>，上線請改）。</div>
        </div>

        <div id="addProductForm" style="display:none;margin-top:12px">
          <h4>新增商品</h4>
          <form id="productForm">
            <div class="row">
              <div style="flex:1">
                <label>標題</label>
                <input id="prodTitle" required />
              </div>
              <div style="width:180px">
                <label>上傳照片</label>
                <input id="prodImage" type="file" accept="image/*" />
              </div>
            </div>
            <div>
              <label>商品選項（每一列為一個可選商品，需填名稱與單價）</label>
              <div id="optionsContainer"></div>
              <button type="button" class="btn" id="addOptionBtn">＋ 加一個選項</button>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button type="submit" class="btn btn-primary">新增商品</button>
              <button type="button" class="btn" id="cancelAddProduct">取消</button>
            </div>
          </form>
        </div>

        <div id="ordersView" style="display:none;margin-top:12px">
          <h4>所有訂單紀錄</h4>
          <div class="orders-list" id="ordersList"></div>
          <div style="margin-top:8px;font-weight:600">總金額： <span id="ordersTotal">0</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 登入/註冊面板 -->
  <div id="authPanel" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:60;min-width:320px">
    <div class="card">
      <h3 style="margin:0 0 8px 0">註冊 / 登入</h3>
      <div style="display:flex;gap:8px">
        <div style="flex:1">
          <h4 style="margin:4px 0">註冊</h4>
          <form id="registerForm">
            <label>Email</label>
            <input id="regEmail" type="email" required />
            <label>名字</label>
            <input id="regName" required />
            <label>電話</label>
            <input id="regPhone" required />
            <label>管理員專用代碼（若要註冊成為管理員填入）</label>
            <input id="regAdminCode" placeholder="若不是管理員留空" />
            <div style="margin-top:8px">
              <button class="btn btn-primary">註冊</button>
            </div>
          </form>
        </div>
        <div style="width:1px;background:#eee"></div>
        <div style="width:220px">
          <h4 style="margin:4px 0">登入</h4>
          <form id="loginForm">
            <label>Email</label>
            <input id="loginEmail" type="email" required />
            <label>非安全密碼（示範，登入只需 email）</label>
            <input id="loginPass" />
            <div style="margin-top:8px">
              <button class="btn btn-primary">登入</button>
            </div>
          </form>
        </div>
      </div>
      <div style="margin-top:8px;text-align:right">
        <button class="btn" id="closeAuth">關閉</button>
      </div>
    </div>
  </div>

  <!-- 商品下單 modal -->
  <div id="orderModal" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:70;min-width:320px;max-width:830px">
    <div class="card">
      <div style="display:flex;align-items:center;gap:8px">
        <h3 id="orderTitle" style="margin:0">商品</h3>
        <div class="right">
          <button class="btn" id="closeOrder">關閉</button>
        </div>
      </div>
      <div id="orderBody" style="margin-top:12px"></div>
    </div>
  </div>

</div>

<script>
/* ======= 簡易資料模型存在 localStorage =======
keys:
- users: array of {email,name,phone,isAdmin}
- products: array of {id,title,imageBase64,options: [{name,price}]}
- orders: array of {id,userEmail,items:[{prodId,optionIndex,qty,unitPrice,name}],total,ts}
==============================================*/

// helper localStorage
const DB = {
  get(key){ return JSON.parse(localStorage.getItem(key) || 'null'); },
  set(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
};

// init
if (!DB.get('users')) DB.set('users', []);
if (!DB.get('products')) DB.set('products', []);
if (!DB.get('orders')) DB.set('orders', []);

// preset admin code (示範) —— 上線請改成更安全的方式
const ADMIN_CODE = 'letmein123';

// current session
let currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');

// UI refs
const userArea = document.getElementById('userArea');
const currentUserInfo = document.getElementById('currentUserInfo');
const openRegister = document.getElementById('openRegister');
const authPanel = document.getElementById('authPanel');
const closeAuth = document.getElementById('closeAuth');
const registerForm = document.getElementById('registerForm');
const loginForm = document.getElementById('loginForm');
const openAdminPanelBtn = document.getElementById('openAdminPanel');
const adminPanel = document.getElementById('adminPanel');
const closeAdmin = document.getElementById('closeAdmin');
const showAddProduct = document.getElementById('showAddProduct');
const showOrders = document.getElementById('showOrders');
const addProductForm = document.getElementById('addProductForm');
const productForm = document.getElementById('productForm');
const optionsContainer = document.getElementById('optionsContainer');
const addOptionBtn = document.getElementById('addOptionBtn');
const cancelAddProduct = document.getElementById('cancelAddProduct');
const ordersView = document.getElementById('ordersView');
const ordersList = document.getElementById('ordersList');
const ordersTotal = document.getElementById('ordersTotal');
const mainContent = document.getElementById('mainContent');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const clearSearch = document.getElementById('clearSearch');

const orderModal = document.getElementById('orderModal');
const orderBody = document.getElementById('orderBody');
const orderTitle = document.getElementById('orderTitle');
const closeOrder = document.getElementById('closeOrder');

// helpers
function saveSession(){ sessionStorage.setItem('currentUser', JSON.stringify(currentUser || null)); updateHeader(); }
function updateHeader(){
  if (currentUser){
    currentUserInfo.textContent = currentUser.name + ' (' + currentUser.email + ')';
    userArea.innerHTML = '<span class="admin-badge">' + (currentUser.isAdmin? '管理員' : '一般會員') + '</span> <button class="btn" id="logoutBtn">登出</button>';
    document.getElementById('logoutBtn').onclick = ()=>{ currentUser=null; saveSession(); };
  } else {
    currentUserInfo.textContent = '未登入';
    userArea.innerHTML = '<span class="muted">未登入</span>';
  }
}
updateHeader();

// render products
function renderProducts(filter=null){
  const prods = DB.get('products') || [];
  let results = prods;
  if (filter){
    const q = filter.toLowerCase();
    results = prods.filter(p=>{
      if ((p.title||'').toLowerCase().includes(q)) return true;
      for (const opt of p.options){
        if ((opt.name||'').toLowerCase().includes(q)) return true;
      }
      return false;
    });
  }
  mainContent.innerHTML = '';
  if (results.length===0) {
    mainContent.innerHTML = '<div class="card">目前沒有商品</div>';
    return;
  }
  for (const p of results){
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <img src="${p.imageBase64}" class="product-img" />
      <h4 style="margin:8px 0 4px 0">${p.title}</h4>
      <div class="small muted">選項：${p.options.map(o=>o.name).join('、')}</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn" data-id="${p.id}" onclick="openIntro('${p.id}')">查看/下單</button>
      </div>
    `;
    mainContent.appendChild(div);
  }
}
window.openIntro = function(id){
  const prods = DB.get('products')||[];
  const p = prods.find(x=>x.id===id);
  if (!p) return alert('找不到商品');
  orderTitle.textContent = p.title;
  orderBody.innerHTML = `
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <img src="${p.imageBase64}" style="width:260px;height:180px;object-fit:cover;border-radius:6px" />
      <div style="flex:1">
        <h3 style="margin:0">${p.title}</h3>
        <div class="small muted">選項如下，請選擇數量（0 表示不訂）或選「其他」輸入數量）</div>
        <div style="margin-top:8px">
          <table id="orderTable"><thead><tr><th>選項</th><th>單價</th><th>數量</th></tr></thead><tbody>
            ${p.options.map((opt,idx)=>`
              <tr>
                <td>${opt.name}</td>
                <td>${opt.price}</td>
                <td>
                  <select data-idx="${idx}">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="other">其他</option>
                  </select>
                  <input type="number" min="0" placeholder="輸入數量" style="width:80px;display:none" data-idx="${idx}" />
                </td>
              </tr>
            `).join('')}
          </tbody></table>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn btn-primary" id="placeOrderBtn">下單</button>
            <button class="btn" id="cancelOrderBtn">取消</button>
          </div>
        </div>
      </div>
    </div>
  `;
  // attach events for other
  const selects = orderBody.querySelectorAll('select');
  selects.forEach(s=>{
    s.onchange = (e)=>{
      const val = e.target.value;
      const idx = e.target.getAttribute('data-idx');
      const inp = orderBody.querySelector(`input[data-idx="${idx}"]`);
      if (val === 'other'){ inp.style.display='inline-block'; inp.value=''; inp.focus(); }
      else inp.style.display='none';
    };
  });

  document.getElementById('placeOrderBtn').onclick = ()=>{
    if (!currentUser) return alert('請先登入才能下單');
    const rows = orderBody.querySelectorAll('tbody tr');
    const items = [];
    let total = 0;
    rows.forEach((tr,i)=>{
      const optIndex = i;
      const sel = tr.querySelector('select');
      let qty = sel.value;
      if (qty === 'other'){
        const inp = tr.querySelector('input');
        qty = Number(inp.value) || 0;
      } else qty = Number(qty);
      qty = Math.max(0, qty);
      if (qty>0){
        const unit = p.options[optIndex].price;
        items.push({
          prodId: p.id,
          optionIndex: optIndex,
          qty,
          unitPrice: unit,
          name: p.options[optIndex].name
        });
        total += qty * unit;
      }
    });
    if (items.length===0) return alert('未選擇任何商品數量');
    const orders = DB.get('orders') || [];
    const order = {
      id: 'o_' + Date.now(),
      userEmail: currentUser.email,
      items,
      total,
      ts: new Date().toISOString()
    };
    orders.push(order);
    DB.set('orders', orders);
    alert('下單成功！總金額：' + total);
    renderProducts(searchInput.value.trim());
    closeOrderModal();
  };

  document.getElementById('cancelOrderBtn').onclick = closeOrderModal;
  openOrderModal();
};

function openOrderModal(){ orderModal.style.display='block'; }
function closeOrderModal(){ orderModal.style.display='none'; }

// 注册 / 登入
openRegister.onclick = ()=>{ authPanel.style.display='block'; };
closeAuth.onclick = ()=>{ authPanel.style.display='none'; };

registerForm.onsubmit = (e)=>{
  e.preventDefault();
  const email = document.getElementById('regEmail').value.trim().toLowerCase();
  const name = document.getElementById('regName').value.trim();
  const phone = document.getElementById('regPhone').value.trim();
  const code = document.getElementById('regAdminCode').value.trim();
  if (!email || !name || !phone) return alert('請完整填寫');
  const users = DB.get('users') || [];
  if (users.find(u=>u.email===email)) return alert('此 email 已被註冊');
  const user = {email, name, phone, isAdmin: code===ADMIN_CODE};
  users.push(user);
  DB.set('users', users);
  currentUser = user;
  saveSession();
  alert('註冊完成 ' + (user.isAdmin? '（管理員）':''));
  authPanel.style.display='none';
  renderProducts();
};

loginForm.onsubmit = (e)=>{
  e.preventDefault();
  const email = document.getElementById('loginEmail').value.trim().toLowerCase();
  const users = DB.get('users') || [];
  const user = users.find(u=>u.email===email);
  if (!user) return alert('找不到此帳號，請先註冊');
  currentUser = user;
  saveSession();
  alert('登入成功');
  authPanel.style.display='none';
};

// 管理後台
openAdminPanelBtn.onclick = ()=>{
  if (!currentUser || !currentUser.isAdmin) return alert('僅管理員可開啟後台');
  adminPanel.style.display = 'block';
  showAddProduct.click();
};
closeAdmin.onclick = ()=>{ adminPanel.style.display='none'; addProductForm.style.display='none'; ordersView.style.display='none'; };

// add product form controls
showAddProduct.onclick = ()=>{
  addProductForm.style.display='block';
  ordersView.style.display='none';
  populateOptionRow(); // 預設一列
};
showOrders.onclick = ()=>{
  addProductForm.style.display='none';
  ordersView.style.display='block';
  renderOrders();
};

function populateOptionRow(name='',price=''){
  const idx = optionsContainer.children.length;
  const div = document.createElement('div');
  div.style.marginBottom='6px';
  div.innerHTML = `
    <div style="display:flex;gap:8px">
      <input placeholder="選項名稱" data-name />
      <input placeholder="單價 (數字)" data-price style="width:120px" />
      <button class="btn" data-remove>移除</button>
    </div>
  `;
  optionsContainer.appendChild(div);
  div.querySelector('[data-name]').value = name;
  div.querySelector('[data-price]').value = price;
  div.querySelector('[data-remove]').onclick = ()=>div.remove();
}
addOptionBtn.onclick = ()=> populateOptionRow();

cancelAddProduct.onclick = ()=>{
  addProductForm.style.display='none';
  optionsContainer.innerHTML='';
};

// product form submit
productForm.onsubmit = async (e)=>{
  e.preventDefault();
  const title = document.getElementById('prodTitle').value.trim();
  const file = document.getElementById('prodImage').files[0];
  if (!title) return alert('請填標題');
  // gather options
  const opts = [];
  const rows = optionsContainer.querySelectorAll('div');
  for (const r of rows){
    const name = r.querySelector('[data-name]').value.trim();
    const price = Number(r.querySelector('[data-price]').value);
    if (!name || isNaN(price)) return alert('請填選項名稱與正確單價');
    opts.push({name, price});
  }
  if (opts.length===0) return alert('請至少新增一個選項');
  // image to base64
  let b64 = '';
  if (file){
    b64 = await readFileAsDataURL(file);
  } else {
    b64 = 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="600" height="360"><rect width="100%" height="100%" fill="#ddd"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#666" font-size="20">No Image</text></svg>`);
  }
  const prods = DB.get('products') || [];
  prods.push({id:'p_'+Date.now(), title, imageBase64:b64, options:opts});
  DB.set('products', prods);
  alert('商品新增完成');
  // reset
  productForm.reset();
  optionsContainer.innerHTML='';
  addProductForm.style.display='none';
  renderProducts();
};

function readFileAsDataURL(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=>res(fr.result);
    fr.onerror = ()=>rej();
    fr.readAsDataURL(file);
  });
}

// orders rendering in admin
function renderOrders(){
  const orders = DB.get('orders') || [];
  if (orders.length===0){
    ordersList.innerHTML = '<div class="muted">目前無訂單</div>';
    ordersTotal.textContent = '0';
    return;
  }
  ordersList.innerHTML = '';
  let grand = 0;
  orders.forEach(o=>{
    grand += o.total;
    const d = document.createElement('div');
    d.style.borderBottom='1px solid #eee';
    d.style.padding='8px 0';
    d.innerHTML = `
      <div style="display:flex;gap:8px;align-items:center">
        <div>
          <div><strong>${o.userEmail}</strong> <span class="small muted">(${o.ts})</span></div>
          <div class="small muted">訂單編號: ${o.id}</div>
        </div>
        <div class="right" style="margin-left:auto">
          <div>總計：<strong>${o.total}</strong></div>
        </div>
      </div>
      <div style="margin-top:6px">
        <table><thead><tr><th>項目</th><th>單價</th><th>數量</th><th>小計</th></tr></thead>
          <tbody>
            ${o.items.map(it=>`<tr><td>${it.name}</td><td>${it.unitPrice}</td><td>${it.qty}</td><td>${it.unitPrice*it.qty}</td></tr>`).join('')}
          </tbody>
        </table>
      </div>
    `;
    ordersList.appendChild(d);
  });
  ordersTotal.textContent = grand;
}

// simple search
searchBtn.onclick = ()=>{ renderProducts(searchInput.value.trim()); };
clearSearch.onclick = ()=>{ searchInput.value=''; renderProducts(); };

// initial render
renderProducts();

// order modal close
closeOrder.onclick = closeOrderModal;

// utility: if no products, add sample (第一次使用可取消註解)
/*
if ((DB.get('products') || []).length === 0){
  DB.set('products', [{
    id:'p_sample',
    title:'示範商品組合',
    imageBase64: 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="600" height="360"><rect width="100%" height="100%" fill="#ddd"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#666" font-size="20">Sample</text></svg>`),
    options: [{name:'商品1', price:100},{name:'商品2', price:200}]
  }]);
  renderProducts();
}
*/

// 小功能：允許管理員把別人設成管理員（簡單範例）
function promoteToAdmin(email){
  const users = DB.get('users') || [];
  const u = users.find(x=>x.email===email);
  if (!u) return false;
  u.isAdmin = true;
  DB.set('users', users);
  return true;
}

// 暴露幾個方法到 global（偵錯 / 測試用）
window._debug = {
  DB,
  promoteToAdmin
};
</script>
</body>
</html>
