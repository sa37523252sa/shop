<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>簡易商品訂購系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* ====== 基本樣式 ====== */
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  margin: 0;
  padding: 0;
}

header {
  background: white;
  padding: 16px;
  border-bottom: 1px solid #ddd;
}

h1 {
  margin: 0;
  font-size: 20px;
  font-weight: bold;
}

.container {
  max-width: 900px;
  margin: auto;
  padding: 16px;
}

.card {
  background: white;
  padding: 16px;
  border-radius: 6px;
  margin-bottom: 16px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

/* 商品封面圖片 */
.product-img {
  width: 100%;
  height: 220px;
  object-fit: contain;
  background: #fff;
  border-radius: 6px;
}

/* 按鈕 */
.btn {
  background: #ddd;
  border: none;
  padding: 8px 14px;
  border-radius: 4px;
  cursor: pointer;
  margin-right: 4px;
}

.btn-primary {
  background: #007bff;
  color: white;
}

.small {
  font-size: 12px;
  color: #666;
}
</style>
</head>

<body>

<header>
  <h1>簡易商品訂購系統</h1>
  <div id="userArea"></div>
</header>

<div class="container">
  <div class="card">
    <input id="searchInput" placeholder="搜尋商品" />
    <button class="btn" id="searchBtn">搜尋</button>
    <button class="btn" id="clearSearch">清除</button>
    <button class="btn btn-primary" id="openLogin">登入 / 註冊</button>
    <button class="btn" id="openAdmin">新增商品（管理員）</button>
  </div>

  <div id="mainContent"></div>
</div>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>簡易商品訂購系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* ====== 基本樣式 ====== */
    body {
      font-family: Arial, "Noto Sans TC", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    header {
      background: #fff;
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      margin: 0;
      font-size: 18px;
      font-weight: bold;
    }

    .container {
      max-width: 960px;
      margin: auto;
      padding: 16px;
    }

    .card {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    /* 商品封面圖片 */
    .product-img {
      width: 100%;
      height: 220px;
      object-fit: contain;
      background: #fff;
      border-radius: 6px;
    }

    .btn {
      background: #e0e0e0;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 4px;
    }

    .btn-primary {
      background: #2b8cff;
      color: #fff;
    }

    .btn-danger {
      background: #e53935;
      color: #fff;
    }

    input, textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 14px;
    }

    label {
      font-size: 13px;
      margin-bottom: 4px;
      display: block;
    }

    .small {
      font-size: 12px;
      color: #666;
    }

    .flex {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .flex-space {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* ====== Modal ====== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    .modal {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .modal h3 {
      margin-top: 0;
    }

    .option-row {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
    }

    .option-row input {
      flex: 1;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #ffd700;
      margin-left: 6px;
    }
  </style>
</head>

<body>
  <header>
    <div>
      <h1>簡易商品訂購系統</h1>
      <div class="small">後端：Render + PostgreSQL</div>
    </div>
    <div id="userArea" class="small">載入中...</div>
  </header>

  <div class="container">
    <!-- 搜尋列 -->
    <div class="card">
      <div class="flex-space">
        <div class="flex" style="flex:1">
          <input id="searchInput" placeholder="輸入關鍵字搜尋商品" />
          <button class="btn" id="searchBtn">搜尋</button>
          <button class="btn" id="clearSearch">清除</button>
        </div>
        <div>
          <button class="btn" id="openLogin">登入 / 註冊</button>
          <button class="btn" id="logoutBtn" style="display:none">登出</button>
          <button class="btn btn-primary" id="openAdmin">新增商品（管理員）</button>
        </div>
      </div>
    </div>

    <!-- 商品列表 -->
    <div id="mainContent" class="grid"></div>
  </div>

  <!-- ====== 登入 / 註冊 Modal ====== -->
  <div id="authBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3>登入 / 註冊</h3>
      <div class="flex" style="margin-bottom:8px">
        <button class="btn btn-primary" id="tabLogin">登入</button>
        <button class="btn" id="tabRegister">註冊</button>
      </div>

      <div id="loginPanel">
        <label>Email</label>
        <input id="loginEmail" type="email" />

        <label style="margin-top:8px">密碼</label>
        <input id="loginPassword" type="password" />

        <div style="margin-top:12px">
          <button class="btn btn-primary" id="loginSubmit">登入</button>
          <button class="btn" id="authClose1">關閉</button>
        </div>
      </div>

      <div id="registerPanel" style="display:none">
        <label>Email</label>
        <input id="regEmail" type="email" />

        <label style="margin-top:8px">姓名</label>
        <input id="regName" />

        <label style="margin-top:8px">密碼</label>
        <input id="regPassword" type="password" />

        <label style="margin-top:8px">管理員邀請碼（可留空）</label>
        <input id="regAdminCode" />

        <div style="margin-top:12px">
          <button class="btn btn-primary" id="registerSubmit">註冊</button>
          <button class="btn" id="authClose2">關閉</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== 新增商品 Modal（管理員） ====== -->
  <div id="adminBackdrop" class="modal-backdrop">
    <div class="modal" style="max-width:520px">
      <h3>新增商品</h3>

      <label>標題</label>
      <input id="prodTitle" />

      <label style="margin-top:8px">上傳圖片</label>
      <input id="prodImage" type="file" accept="image/*" />

      <label style="margin-top:8px">商品選項（每一列一個選項名稱，選填）</label>
      <div id="optionsContainer"></div>
      <button class="btn" id="addOptionBtn" type="button">＋新增選項欄位</button>

      <div style="margin-top:12px">
        <button class="btn btn-primary" id="productSubmit">送出</button>
        <button class="btn" id="adminClose">關閉</button>
      </div>

      <div class="small" style="margin-top:8px">
        新增商品會送到後端：/products/add，圖片會上傳到 Cloudinary。
      </div>
    </div>
  </div>

  <script>
    // ====== 後端 API base URL (Render) ======
    const API_BASE = "https://shop-3b84.onrender.com";

    // ====== 狀態：目前登入使用者 ======
    let currentUser = null; // { token, email, name, is_admin }

    // 儲存 / 讀取使用者
    function loadUserFromStorage() {
      try {
        const raw = localStorage.getItem("shop_user");
        if (!raw) return null;
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    function saveUserToStorage(user) {
      if (!user) {
        localStorage.removeItem("shop_user");
      } else {
        localStorage.setItem("shop_user", JSON.stringify(user));
      }
    }

    // ====== DOM 參照 ======
    const userArea = document.getElementById("userArea");
    const logoutBtn = document.getElementById("logoutBtn");
    const openLoginBtn = document.getElementById("openLogin");
    const openAdminBtn = document.getElementById("openAdmin");

    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const clearSearch = document.getElementById("clearSearch");
    const mainContent = document.getElementById("mainContent");

    const authBackdrop = document.getElementById("authBackdrop");
    const adminBackdrop = document.getElementById("adminBackdrop");

    const tabLogin = document.getElementById("tabLogin");
    const tabRegister = document.getElementById("tabRegister");
    const loginPanel = document.getElementById("loginPanel");
    const registerPanel = document.getElementById("registerPanel");

    const loginEmail = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");
    const loginSubmit = document.getElementById("loginSubmit");

    const regEmail = document.getElementById("regEmail");
    const regName = document.getElementById("regName");
    const regPassword = document.getElementById("regPassword");
    const regAdminCode = document.getElementById("regAdminCode");
    const registerSubmit = document.getElementById("registerSubmit");

    const authClose1 = document.getElementById("authClose1");
    const authClose2 = document.getElementById("authClose2");

    const prodTitle = document.getElementById("prodTitle");
    const prodImage = document.getElementById("prodImage");
    const optionsContainer = document.getElementById("optionsContainer");
    const addOptionBtn = document.getElementById("addOptionBtn");
    const productSubmit = document.getElementById("productSubmit");
    const adminClose = document.getElementById("adminClose");

    // ====== UI 工具 ======
    function openModal(backdrop) {
      backdrop.style.display = "flex";
    }
    function closeModal(backdrop) {
      backdrop.style.display = "none";
    }

    function updateUserArea() {
      if (!currentUser) {
        userArea.innerHTML = '未登入';
        logoutBtn.style.display = "none";
      } else {
        userArea.innerHTML =
          '已登入：' +
          currentUser.name +
          " (" + currentUser.email + ")" +
          (currentUser.is_admin ? '<span class="badge">管理員</span>' : "");
        logoutBtn.style.display = "inline-block";
      }
    }

    // ====== 產品相關 ======
    async function fetchProducts(keyword) {
      try {
        let url = API_BASE + "/products/list";
        if (keyword && keyword.trim() !== "") {
          url = API_BASE + "/products/search?keyword=" + encodeURIComponent(keyword.trim());
        }
        const res = await fetch(url);
        if (!res.ok) throw new Error("後端回應錯誤");
        const data = await res.json();
        renderProducts(data);
      } catch (err) {
        console.error(err);
        mainContent.innerHTML =
          '<div class="card">無法載入商品，可能是後端睡著了或連線失敗。</div>';
      }
    }

    function renderProducts(products) {
      mainContent.innerHTML = "";
      if (!products || products.length === 0) {
        mainContent.innerHTML = '<div class="card">目前沒有任何商品</div>';
        return;
      }

      for (const p of products) {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <img src="${p.image_url || ""}" class="product-img" onerror="this.style.display='none';" />
          <h3 style="margin-top:8px">${p.title}</h3>
          <div class="small">商品編號：${p.id}</div>
        `;
        mainContent.appendChild(div);
      }
    }

    // ====== 登入 / 註冊 API ======
    async function login() {
      const email = loginEmail.value.trim();
      const password = loginPassword.value.trim();
      if (!email || !password) {
        alert("請輸入 email 和密碼");
        return;
      }
      try {
        const res = await fetch(API_BASE + "/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.message || "登入失敗");
          return;
        }
        currentUser = {
          token: data.token,
          email: data.user.email,
          name: data.user.name,
          is_admin: !!data.user.is_admin
        };
        saveUserToStorage(currentUser);
        updateUserArea();
        closeModal(authBackdrop);
        alert("登入成功");
      } catch (err) {
        console.error(err);
        alert("登入失敗，請稍後再試");
      }
    }

    async function registerUser() {
      const email = regEmail.value.trim();
      const name = regName.value.trim();
      const password = regPassword.value.trim();
      const admin_code = regAdminCode.value.trim();
      if (!email || !name || !password) {
        alert("請填寫完整註冊資料");
        return;
      }
      try {
        const res = await fetch(API_BASE + "/auth/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, name, password, admin_code })
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.message || "註冊失敗");
          return;
        }
        alert("註冊成功，請使用剛剛的帳號登入");
        // 自動切換到登入頁籤
        tabLogin.click();
      } catch (err) {
        console.error(err);
        alert("註冊失敗，請稍後再試");
      }
    }

    // ====== 新增商品（管理員） ======
    function addOptionRow(value = "") {
      const div = document.createElement("div");
      div.className = "option-row";
      div.innerHTML = `
        <input type="text" placeholder="選項名稱" value="${value.replace(/"/g, "&quot;")}" />
        <button class="btn btn-danger" type="button">刪除</button>
      `;
      const btn = div.querySelector("button");
      btn.onclick = () => div.remove();
      optionsContainer.appendChild(div);
    }

    async function submitProduct() {
      if (!currentUser || !currentUser.token) {
        alert("請先登入");
        return;
      }
      if (!currentUser.is_admin) {
        alert("只有管理員可以新增商品");
        return;
      }

      const title = prodTitle.value.trim();
      const file = prodImage.files[0];

      if (!title) {
        alert("請輸入商品標題");
        return;
      }

      const formData = new FormData();
      formData.append("title", title);

      if (file) {
        formData.append("image", file);
      }

      // 把每一個選項名稱變成一個 options 欄位（後端會得到陣列）
      const rows = optionsContainer.querySelectorAll(".option-row input");
      rows.forEach((input) => {
        const v = input.value.trim();
        if (v) formData.append("options", v);
      });

      try {
        const res = await fetch(API_BASE + "/products/add", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + currentUser.token
          },
          body: formData
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.message || "新增商品失敗");
          return;
        }
        alert("新增商品成功！");
        // 清空表單
        prodTitle.value = "";
        prodImage.value = "";
        optionsContainer.innerHTML = "";
        addOptionRow();
        closeModal(adminBackdrop);
        fetchProducts(); // 重新載入商品
      } catch (err) {
        console.error(err);
        alert("新增商品失敗，請稍後再試");
      }
    }

    // ====== 事件綁定 ======
    openLoginBtn.onclick = () => {
      openModal(authBackdrop);
    };

    [authClose1, authClose2].forEach(btn => {
      btn.onclick = () => closeModal(authBackdrop);
    });

    tabLogin.onclick = () => {
      tabLogin.classList.add("btn-primary");
      tabRegister.classList.remove("btn-primary");
      loginPanel.style.display = "block";
      registerPanel.style.display = "none";
    };

    tabRegister.onclick = () => {
      tabRegister.classList.add("btn-primary");
      tabLogin.classList.remove("btn-primary");
      loginPanel.style.display = "none";
      registerPanel.style.display = "block";
    };

    loginSubmit.onclick = login;
    registerSubmit.onclick = registerUser;

    logoutBtn.onclick = () => {
      currentUser = null;
      saveUserToStorage(null);
      updateUserArea();
      alert("已登出");
    };

    // 管理員新增商品
    openAdminBtn.onclick = () => {
      if (!currentUser) {
        alert("請先登入");
        return;
      }
      if (!currentUser.is_admin) {
        alert("只有管理員可以新增商品");
        return;
      }
      openModal(adminBackdrop);
    };

    adminClose.onclick = () => closeModal(adminBackdrop);

    addOptionBtn.onclick = () => addOptionRow();

    productSubmit.onclick = submitProduct;

    // 搜尋
    searchBtn.onclick = () => {
      fetchProducts(searchInput.value);
    };
    clearSearch.onclick = () => {
      searchInput.value = "";
      fetchProducts();
    };

    // 點 backdrop 關閉（選擇性）
    authBackdrop.addEventListener("click", (e) => {
      if (e.target === authBackdrop) closeModal(authBackdrop);
    });
    adminBackdrop.addEventListener("click", (e) => {
      if (e.target === adminBackdrop) closeModal(adminBackdrop);
    });

    // ====== 初始化 ======
    (function init() {
      currentUser = loadUserFromStorage();
      updateUserArea();
      addOptionRow();      // 預設一個選項欄位
      fetchProducts();     // 一開始載入商品
    })();
  </script>
</body>
</html>
